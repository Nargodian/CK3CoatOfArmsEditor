CK3 COAT OF ARMS EDITOR - PACKAGING AND REFACTORING PLAN
==========================================================

IMPORTANT: CREATE A NEW BRANCH
-------------------------------
This refactoring involves significant structural changes to the project. It is STRONGLY RECOMMENDED
to create a new git branch before beginning implementation to preserve the current working state.

Recommended branch name: feature/portable-exe-packaging or refactor/two-exe-distribution

Command: git checkout -b feature/portable-exe-packaging

OVERVIEW
--------
Transform the Python-based CK3 Coat of Arms Editor into a distributable application with two standalone executables:
1. CoatOfArmsEditor.exe - The main GUI application for creating/editing coat of arms
2. AssetConverter.exe - GUI tool to extract and convert CK3 game assets

PROBLEM STATEMENT
-----------------
- Current state: Python project requiring users to install Python, dependencies, and manually set up environment
- Asset issue: Cannot distribute CK3 game assets (copyrighted) - users must own the game
- Goal: Double-click executable experience with asset extraction from user's own CK3 installation

TARGET DISTRIBUTION STRUCTURE
------------------------------
After extracting the zip, users see:

CK3CoatOfArmsEditor/
├── CoatOfArmsEditor.exe      # Main editor
├── AssetConverter.exe         # Asset extraction/conversion tool
├── _internal/                 # Shared Python/Qt DLLs (PyInstaller managed)
└── ck3_assets/               # Generated by AssetConverter (initially absent)
    ├── coa_emblems/
    │   ├── metadata/          # JSON files converted from CK3 .txt
    │   ├── source/            # Flat PNGs (direct DDS→PNG conversion, 256x256)
    │   └── atlases/           # Pre-baked emblem atlas PNGs (512x512, 4-quadrant)
    ├── coa_patterns/
    │   ├── metadata/          # JSON files converted from CK3 .txt
    │   ├── source/            # Flat PNGs (direct DDS→PNG conversion, 256x256)
    │   └── atlases/           # Pre-baked pattern atlas PNGs (512x256, 2-tile)
    └── coa_frames/            # Frame border PNGs (dynasty, house, variants, masks)

USER WORKFLOW
-------------
1. Extract zip to any location
2. Run AssetConverter.exe
   - Select CK3 installation directory (e.g., E:\Program Files (x86)\Steam\steamapps\common\Crusader Kings III)
   - Tool validates paths and converts assets (15-20 min first run, 2-3 min incremental)
   - Creates ck3_assets/ folder with all required files
3. Run CoatOfArmsEditor.exe
   - Loads assets from ck3_assets/ folder
   - Creates and edits coat of arms designs

IMPLEMENTATION STEPS
--------------------

STEP 1: CREATE UNIFIED ASSET CONVERTER WITH PyQt5 GUI
File: asset_converter.py (new unified tool)

Features:
- PyQt5 GUI with directory picker for CK3 installation
- Path validation before processing:
  - <CK3_DIR>/game/gfx/coat_of_arms/colored_emblems/*.dds
  - <CK3_DIR>/game/gfx/coat_of_arms/patterns/*.dds
  - <CK3_DIR>/game/gfx/interface/coat_of_arms/coa_frames/*.dds
  - <CK3_DIR>/game/common/coat_of_arms/colored_emblems/*.txt
  - <CK3_DIR>/game/common/coat_of_arms/patterns/*.txt
  - <CK3_DIR>/game/common/coat_of_arms/color_palettes/*.txt
  - <CK3_DIR>/game/common/coat_of_arms/emblem_layouts/*.txt
- Progress bars for each phase:
  - Emblem extraction (1585+ files)
  - Pattern extraction (43 files)
  - Frame extraction (66 files)
  - Metadata conversion (.txt → JSON)
- Error handling: Skip corrupted/unsupported DDS files with warning, continue processing
- Clear error messages if paths don't exist

Combines functionality from:
- tools/bake_emblem_atlases.py
- tools/bake_pattern_atlases.py
- tools/ck3_to_json_converter.py
- tools/extract_ck3_colors.py
Plus new frame extraction

STEP 2: IMPLEMENT INCREMENTAL UPDATE LOGIC
Purpose: Reduce re-processing time from 15-20 minutes to 2-3 minutes

Logic:
- Check if output file exists before processing
- Compare source DDS file timestamp with output PNG timestamp
- Skip if output is newer than source
- Process only new/modified files
- Display "X files skipped, Y files processed" summary

STEP 3: ADD ERROR HANDLING WITH SKIP-AND-CONTINUE
Error scenarios:
- DDS file corrupted or unreadable
- Unsupported DDS compression format (BC1/BC3 issues)
- Missing metadata files

Behavior:
- Catch exceptions during DDS loading
- Log warning with filename to UI
- Append to error log file (conversion_errors.txt)
- Continue to next file
- Show summary at end: "X errors, see conversion_errors.txt"

STEP 4: ADD METADATA CONVERSION
Source paths (CK3 .txt files):
- <CK3_DIR>/game/common/coat_of_arms/colored_emblems/*.txt
- <CK3_DIR>/game/common/coat_of_arms/patterns/*.txt
- <CK3_DIR>/game/common/coat_of_arms/color_palettes/*.txt
- <CK3_DIR>/game/common/coat_of_arms/emblem_layouts/*.txt

Output paths:
- ck3_assets/coa_emblems/metadata/50_coa_designer_emblems.json
- ck3_assets/coa_patterns/metadata/50_coa_designer_patterns.json
- ck3_assets/coa_emblems/metadata/50_coa_designer_palettes.json (or separate folder)
- ck3_assets/coa_emblems/metadata/50_coa_designer_emblem_layouts.json

Use existing ck3_to_json_converter.py logic with updated output paths

STEP 5: ADD EMBLEM/PATTERN/FRAME EXTRACTION
Technology: imageio with imageio-dds plugin for DDS loading

A. EMBLEM PROCESSING
Source: <CK3_DIR>/game/gfx/coat_of_arms/colored_emblems/ce_*.dds
Process:
1. Load DDS with imageio (returns numpy array)
2. Convert to RGBA PNG (256x256)
3. Save flat PNG to ck3_assets/coa_emblems/source/ce_*.png
4. Bake into atlas (512x512, 4 quadrants):
   - Red quadrant: White RGB with red channel as alpha
   - Green quadrant: White RGB with green channel as alpha
   - Blue quadrant: RGB channels with original alpha
   - Alpha quadrant: White RGB with inverted alpha (1-a)
5. Save atlas to ck3_assets/coa_emblems/atlases/ce_*_atlas.png

Both outputs are generated: flat PNG for previews/thumbnails, atlas for runtime rendering

B. PATTERN PROCESSING
Source: <CK3_DIR>/game/gfx/coat_of_arms/patterns/pattern_*.dds
Process:
1. Load DDS with imageio
2. Convert to RGBA PNG (256x256)
3. Save flat PNG to ck3_assets/coa_patterns/source/pattern_*.png
4. Bake into atlas (512x256, 2 tiles):
   - Green tile: White RGB with green channel as alpha
   - Blue tile: White RGB with blue channel as alpha
5. Save atlas to ck3_assets/coa_patterns/atlases/pattern_*_atlas.png

Both outputs are generated: flat PNG for previews/thumbnails, atlas for runtime rendering

C. FRAME EXTRACTION
Source: <CK3_DIR>/game/gfx/interface/coat_of_arms/coa_frames/*.dds
Files needed (66 total):
- dynasty.dds + dynasty_mask.dds
- house.dds + house_mask.dds
- house_china.dds + house_china_mask.dds
- house_japan.dds + house_japan_mask.dds
- house_frame_02.dds through house_frame_30.dds (29 files)
- house_frame_02_mask.dds through house_frame_30_mask.dds (29 files)

Process:
1. Load DDS with imageio
2. Simple conversion to PNG (preserve RGBA exactly)
3. No special processing (unlike emblems/patterns)
4. Frames are 6x1 tile strips (6 prestige levels horizontally)
5. Masks define shield shape clipping region
6. Save to ck3_assets/coa_frames/*.png

STEP 6: CREATE CENTRALIZED PATH RESOLVER
File: src/utils/path_resolver.py (new file)

Purpose: Handle path differences between development and frozen executable

Implementation:
```python
import sys
import os
from pathlib import Path

def get_base_dir() -> Path:
    """Get the base directory for the application.
    
    Returns:
        Path to directory containing the executable (frozen) or project root (dev)
    """
    if getattr(sys, 'frozen', False):
        # Running as PyInstaller executable
        return Path(os.path.dirname(sys.executable))
    else:
        # Running as script - assume this file is in src/utils/
        return Path(__file__).resolve().parent.parent.parent

def get_assets_dir() -> Path:
    """Get the ck3_assets directory path.
    
    Returns:
        Path to ck3_assets folder next to executable or in project root
    """
    return get_base_dir() / "ck3_assets"

def get_shader_dir() -> Path:
    """Get the shader directory path.
    
    Returns:
        Path to bundled shaders (frozen) or src/shaders (dev)
    """
    if getattr(sys, 'frozen', False):
        # Shaders are bundled in _MEIPASS
        return Path(sys._MEIPASS) / "shaders"
    else:
        # Development mode
        return Path(__file__).resolve().parent.parent / "shaders"
```

Files to update with new path resolver:
- src/components/asset_sidebar.py
  - Update: "json_output/colored_emblems/50_coa_designer_emblems.json"
  - Update: "json_output/patterns/50_coa_designer_patterns.json"
  - To: get_assets_dir() / "coa_emblems/metadata/50_coa_designer_emblems.json"

- src/utils/atlas_compositor.py
  - Update: "source_coa_files/emblem_atlases/"
  - Update: "source_coa_files/pattern_atlases/"
  - To: get_assets_dir() / "coa_emblems/atlases/"
  - To: get_assets_dir() / "coa_patterns/atlases/"

- src/components/canvas_widgets/base_layer_renderer.py
  - Update shader loading from relative paths
  - To: get_shader_dir() / "basic.vert", etc.

- src/components/canvas_widget.py (or wherever frame loading occurs)
  - Update: "coa_frames/"
  - To: get_assets_dir() / "coa_frames/"

Search for all occurrences of:
- "json_output/"
- "source_coa_files/"
- "coa_frames/"
- shader path construction
And replace with path_resolver calls

STEP 7: CREATE PYINSTALLER SPEC FILES
Packaging tool: PyInstaller with --onedir mode

A. EDITOR SPEC (editor.spec)
```python
# -*- mode: python ; coding: utf-8 -*-

block_cipher = None

a = Analysis(
    ['src/main.py'],
    pathex=[],
    binaries=[],
    datas=[
        ('src/shaders', 'shaders'),  # Bundle shaders into executable
    ],
    hiddenimports=[
        'PyQt5.sip',
        'PyQt5.QtOpenGL',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,
    name='CoatOfArmsEditor',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    console=False,  # No console window for GUI app
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='CoatOfArmsEditor',
)
```

B. ASSET CONVERTER SPEC (asset_converter.spec)
```python
# -*- mode: python ; coding: utf-8 -*-

block_cipher = None

a = Analysis(
    ['asset_converter.py'],
    pathex=[],
    binaries=[],
    datas=[],
    hiddenimports=[
        'PyQt5.sip',
        'imageio',
        'imageio_dds',
        'PIL',
        'numpy',
    ],
    hookspath=[],
    hooksconfig={},
    runtime_hooks=[],
    excludes=[],
    win_no_prefer_redirects=False,
    win_private_assemblies=False,
    cipher=block_cipher,
    noarchive=False,
)

pyz = PYZ(a.pure, a.zipped_data, cipher=block_cipher)

exe = EXE(
    pyz,
    a.scripts,
    [],
    exclude_binaries=True,
    name='AssetConverter',
    debug=False,
    bootloader_ignore_signals=False,
    strip=False,
    upx=True,
    console=False,  # GUI app
    disable_windowed_traceback=False,
    argv_emulation=False,
    target_arch=None,
    codesign_identity=None,
    entitlements_file=None,
)

coll = COLLECT(
    exe,
    a.binaries,
    a.zipfiles,
    a.datas,
    strip=False,
    upx=True,
    upx_exclude=[],
    name='AssetConverter',
)
```

C. BUILD PROCESS FOR SHARED _INTERNAL FOLDER
To create flat structure with shared DLLs:

1. Build first executable:
   pyinstaller editor.spec
   
2. Build second executable into same dist folder:
   pyinstaller asset_converter.spec
   
3. Manually merge (or use script):
   - Copy dist/CoatOfArmsEditor/CoatOfArmsEditor.exe to dist/merged/
   - Copy dist/AssetConverter/AssetConverter.exe to dist/merged/
   - Copy dist/CoatOfArmsEditor/_internal/ to dist/merged/_internal/
   - Verify both exes share the same _internal folder

4. Test both exes run from dist/merged/

5. Create distribution zip from dist/merged/

DEPENDENCIES
------------
requirements.txt for editor:
PyQt5>=5.15.0
PyOpenGL>=3.1.0
numpy>=1.20.0
Pillow>=9.0.0

requirements.txt for asset_converter:
PyQt5>=5.15.0
Pillow>=9.0.0
numpy>=1.20.0
imageio>=2.25.0
imageio-dds>=0.1.0

requirements.txt for development (both combined):
PyQt5>=5.15.0
PyOpenGL>=3.1.0
Pillow>=9.0.0
numpy>=1.20.0
imageio>=2.25.0
imageio-dds>=0.1.0
PyInstaller>=5.0.0

ASSET STRUCTURE DETAILS
------------------------
ck3_assets/ folder structure (created by AssetConverter):

ck3_assets/
├── coa_emblems/
│   ├── metadata/
│   │   ├── 50_coa_designer_emblems.json
│   │   ├── 50_coa_designer_palettes.json (or in separate folder)
│   │   └── 50_coa_designer_emblem_layouts.json (or in separate folder)
│   ├── source/
│   │   ├── ce__empty_designer.png
│   │   ├── ce_aegishjalmr.png
│   │   └── ... (1585+ files, 256x256 PNG, flat RGBA for thumbnails)
│   └── atlases/
│       ├── ce__empty_designer_atlas.png
│       ├── ce_aegishjalmr_atlas.png
│       └── ... (1585+ files, 512x512 PNG, 4-quadrant for rendering)
├── coa_patterns/
│   ├── metadata/
│   │   └── 50_coa_designer_patterns.json
│   ├── source/
│   │   ├── pattern_solid.png
│   │   ├── pattern_horizontal_stripe.png
│   │   └── ... (43 files, 256x256 PNG, flat RGBA for thumbnails)
│   └── atlases/
│       ├── pattern_solid_atlas.png
│       ├── pattern_horizontal_stripe_atlas.png
│       └── ... (43 files, 512x256 PNG, 2-tile for rendering)
└── coa_frames/
    ├── dynasty.png
    ├── dynasty_mask.png
    ├── house.png
    ├── house_mask.png
    ├── house_china.png
    ├── house_china_mask.png
    ├── house_japan.png
    ├── house_japan_mask.png
    ├── house_frame_02.png
    ├── house_frame_02_mask.png
    └── ... (66 files total)

TECHNICAL NOTES
---------------

1. DDS LOADING
- Use imageio with imageio-dds plugin
- Fallback to Wand if imageio fails (requires ImageMagick binary)
- CK3 uses BC1/BC3 DDS compression typically

2. ATLAS BAKING FORMAT
Emblems (512x512, 4 quadrants in Morton order):
  Top-left:     Red channel (white RGB, red as alpha)
  Top-right:    Green channel (white RGB, green as alpha)
  Bottom-left:  Blue channel (RGB channels, original alpha)
  Bottom-right: Alpha channel (white RGB, inverted alpha)

Patterns (512x256, 2 tiles horizontal):
  Left:  Green channel (white RGB, green as alpha)
  Right: Blue channel (white RGB, blue as alpha)

3. FRAME FORMAT
- 6x1 horizontal tile strip (6 prestige levels)
- Each mask defines shield shape clipping region
- Expected size: 800x800 for masks (editor auto-resizes if different)

4. SHADER BUNDLING
- Shaders are editor code, NOT game assets
- Bundle in executable at sys._MEIPASS/shaders/
- Files: basic.vert, basic.frag, base.frag, design.frag
- No external access needed

5. PYINSTALLER --ONEDIR BENEFITS
- Fast startup (no temp extraction)
- Both exes share DLLs (smaller total size)
- No temp folder accumulation
- Fewer antivirus false positives
- Truly portable (copy folder anywhere)

VALIDATION AND TESTING
-----------------------
1. Test asset_converter on clean system without Python
2. Verify all 1700+ files extract correctly
3. Test incremental updates (modify one DDS, re-run)
4. Test error handling (corrupt a DDS file)
5. Test editor loads all assets correctly
6. Test editor on system without CK3 installed (using pre-converted assets)
7. Verify shaders load from bundled location
8. Test both exes share _internal folder correctly
9. Package final zip and test full user workflow

CURRENT STATE MAPPING
----------------------
Files that will be reorganized/replaced:

WILL BE COMBINED INTO asset_converter.py:
- tools/bake_emblem_atlases.py
- tools/bake_pattern_atlases.py
- tools/ck3_to_json_converter.py
- tools/extract_ck3_colors.py

NEW FILES TO CREATE:
- asset_converter.py (unified GUI tool)
- src/utils/path_resolver.py
- editor.spec
- asset_converter.spec
- requirements.txt (if doesn't exist)

CURRENT ASSETS (will no longer be in repo):
- coa_frames/ (66 files) - will be generated
- coa_interface/ (39 files) - NOT USED, can remove
- source_coa_files/emblem_atlases/ - will be generated
- source_coa_files/pattern_atlases/ - will be generated
- json_output/ - will be generated

FILES TO KEEP AS-IS:
- src/ directory (all editor code)
- src/shaders/ (bundled in exe)
- samples/ (example CoA files)
- tests/
- docs/

MIGRATION CHECKLIST
-------------------
[ ] Create asset_converter.py with PyQt5 GUI
[ ] Add DDS loading with imageio-dds
[ ] Implement emblem atlas baking
[ ] Implement pattern atlas baking
[ ] Implement frame extraction
[ ] Implement metadata conversion (.txt → JSON)
[ ] Add incremental update logic
[ ] Add error handling with skip-and-continue
[ ] Create src/utils/path_resolver.py
[ ] Update all asset loading paths in editor
[ ] Update shader loading in base_layer_renderer.py
[ ] Create editor.spec
[ ] Create asset_converter.spec
[ ] Test builds with PyInstaller
[ ] Merge dist folders for shared _internal
[ ] Test both exes on clean Windows system
[ ] Create distribution zip
[ ] Write user documentation (README.txt in zip)
[ ] Test full user workflow (extract → convert → edit)

END OF PLAN
