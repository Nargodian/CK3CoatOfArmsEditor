CK3 COAT OF ARMS EDITOR - REFACTORING TASK LIST
===============================================

This is an actionable task list for the refactoring project.
Check off tasks as completed. Each phase can be tested independently.


PHASE 1: DIRECTORY STRUCTURE SETUP (2 hours)
=============================================
Priority: FOUNDATION - Required before other refactors

Task 1.1: Create Directory Structure (15 minutes)
--------------------------------------------------
[ ] Create src/services/
[ ] Create src/services/__init__.py
[ ] Create src/components/property_sidebar/
[ ] Create src/components/property_sidebar/__init__.py
[ ] Create src/components/canvas/
[ ] Create src/components/canvas/__init__.py
[ ] Create src/components/transform/
[ ] Create src/components/transform/__init__.py
[ ] Create src/components/assets/
[ ] Create src/components/assets/__init__.py
[ ] Commit: "Add directory structure for refactoring"

Task 1.2: Setup Import Paths (30 minutes)
------------------------------------------
[ ] Update src/components/__init__.py with subpackage imports
[ ] Test that existing imports still work
[ ] Document import path changes in refactor_strategy.txt
[ ] Commit: "Setup import paths for new structure"

Task 1.3: Create Placeholder Files (45 minutes)
------------------------------------------------
[ ] Create empty modules with docstrings:
    - src/utils/color_utils.py
    - src/utils/transform_math.py
    - src/services/file_operations.py
    - src/services/layer_operations.py
    - src/services/coa_serializer.py
[ ] Add basic module docstrings explaining purpose
[ ] Add TODO comments for what will be extracted
[ ] Commit: "Add placeholder modules for refactoring"

Task 1.4: Test Phase 1 Complete
--------------------------------
[ ] Run application - verify no breaks
[ ] Verify imports work
[ ] Commit any fixes
[ ] Tag: v1.0-structure


PHASE 2: EXTRACT UTILITIES (4 hours)
=====================================
Priority: HIGH - No dependencies, can be done early

Task 2.1: Extract Color Utilities (1.5 hours)
----------------------------------------------
[ ] Copy _color_name_to_rgb() from main.py to utils/color_utils.py
[ ] Copy _rgb_to_color_name() from main.py to utils/color_utils.py
[ ] Copy color_map from _color_name_to_rgb into module-level constant
[ ] Add parse_rgb_string() helper for "rgb { R G B }" format
[ ] Import in main.py: from utils.color_utils import color_name_to_rgb, rgb_to_color_name
[ ] Replace all self._color_name_to_rgb() with color_name_to_rgb()
[ ] Replace all self._rgb_to_color_name() with rgb_to_color_name()
[ ] Delete methods from main.py
[ ] Test: Load CoA, verify colors work
[ ] Commit: "Extract color utilities to utils/color_utils.py"

Task 2.2: Extract Transform Math (1 hour)
------------------------------------------
[ ] Open transform_widget.py
[ ] Identify pure math functions (coordinate conversions, AABB)
[ ] Create utils/transform_math.py
[ ] Add functions:
    - screen_to_normalized(x, y, width, height)
    - normalized_to_screen(nx, ny, width, height)
    - calculate_bounds(pos, scale, rotation)
    - constrain_aspect_ratio(scale_x, scale_y)
[ ] Import in transform_widget.py
[ ] Replace inline math with function calls
[ ] Test: Transform layers, verify no changes
[ ] Commit: "Extract transform math utilities"

Task 2.3: Extract Shader Manager (1 hour)
------------------------------------------
[ ] Open canvas_widget.py
[ ] Copy shader compilation code to components/canvas/shader_manager.py
[ ] Create ShaderManager class with:
    - compile_shader(shader_type, source_path)
    - link_program(vertex_path, fragment_path)
    - bind(program)
[ ] Replace shader setup in canvas_widget.initializeGL()
[ ] Test: Run app, verify rendering works
[ ] Commit: "Extract shader manager"

Task 2.4: Test Phase 2 Complete
--------------------------------
[ ] Run application
[ ] Test all color operations (swatches, picker, load/save)
[ ] Test transform operations
[ ] Test rendering
[ ] Tag: v2.0-utilities


PHASE 3: EXTRACT SERVICES (6 hours)
====================================
Priority: HIGH - Separates business logic from UI

Task 3.1: Extract File Operations (2 hours)
--------------------------------------------
[ ] Create services/file_operations.py
[ ] Move save_coa() logic to save_coa_to_file(coa_data, filename)
[ ] Move load_coa() logic to load_coa_from_file(filename)
[ ] Keep QFileDialog in main.py, pass filename to service
[ ] Move copy_coa() logic to coa_to_clipboard_text(coa_data)
[ ] Move paste_coa() logic to coa_from_clipboard_text(text)
[ ] Update main.py to use service functions
[ ] Test: Save, load, copy, paste CoA
[ ] Commit: "Extract file operations service"

Task 3.2: Extract Layer Operations (2 hours)
---------------------------------------------
[ ] Create services/layer_operations.py
[ ] Add create_default_layer(filename, colors=3, **overrides)
[ ] Add duplicate_layers(layers, indices, offset=10)
[ ] Add copy_layer_to_text(layer)
[ ] Add parse_layer_from_text(text)
[ ] Update main.py and property_sidebar to use service
[ ] Test: Create, duplicate, copy/paste layers
[ ] Commit: "Extract layer operations service"

Task 3.3: Extract CoA Serializer (1.5 hours)
---------------------------------------------
[ ] Create services/coa_serializer.py
[ ] Move all CoA building logic from main.py
[ ] Add build_coa_export(base_colors, base_texture, layers)
[ ] Add apply_coa_to_editor(coa_data, canvas, sidebar)
[ ] Keep parsing in utils/coa_parser.py
[ ] Update main.py to use service
[ ] Test: Load/save complete CoA files
[ ] Commit: "Extract CoA serialization service"

Task 3.4: Test Phase 3 Complete
--------------------------------
[ ] Run all file operations
[ ] Test layer operations
[ ] Test CoA import/export
[ ] Verify history still works
[ ] Tag: v3.0-services


PHASE 4: EXTRACT WIDGETS (8 hours)
===================================
Priority: MEDIUM - Improves property_sidebar organization

Task 4.1: Extract Layer List Widget (3 hours)
----------------------------------------------
[ ] Create components/property_sidebar/layer_list_widget.py
[ ] Create LayerListWidget class extending QWidget
[ ] Move layer button creation from property_sidebar
[ ] Move drag-drop system
[ ] Move thumbnail preview logic
[ ] Move selection management
[ ] Update property_sidebar.py to use widget
[ ] Test: Layer list, drag-drop, selection all work
[ ] Commit: "Extract layer list widget"

Task 4.2: Extract Color Picker Widget (1.5 hours)
--------------------------------------------------
[ ] Create components/property_sidebar/color_picker.py
[ ] Create ColorPickerDialog class
[ ] Move color picker dialog code from property_sidebar
[ ] Move swatch creation
[ ] Update property_sidebar to use widget
[ ] Test: Color picking, swatches work
[ ] Commit: "Extract color picker widget"

Task 4.3: Extract Property Editors (2 hours)
---------------------------------------------
[ ] Create components/property_sidebar/property_editors.py
[ ] Create PositionEditor, ScaleEditor, RotationEditor classes
[ ] Move slider/spinbox creation from property_sidebar
[ ] Move value update handlers
[ ] Update property_sidebar to use editors
[ ] Test: Property editing works
[ ] Commit: "Extract property editors"

Task 4.4: Extract Tab Factories (1 hour)
-----------------------------------------
[ ] Create components/property_sidebar/tab_factories.py
[ ] Move create_base_tab() logic
[ ] Move create_layers_tab() logic
[ ] Move create_properties_tab() logic
[ ] Update property_sidebar to use factories
[ ] Test: All tabs work correctly
[ ] Commit: "Extract tab factory functions"

Task 4.5: Test Phase 4 Complete
--------------------------------
[ ] Run application
[ ] Test all property sidebar functionality
[ ] Test layer list operations
[ ] Test property editing
[ ] Verify no regressions
[ ] Tag: v4.0-widgets


PHASE 5: EXTRACT SPECIALIZED MODULES (8 hours)
===============================================
Priority: MEDIUM - Canvas and transform improvements

Task 5.1: Extract Texture Atlas System (3 hours)
-------------------------------------------------
[ ] Create components/canvas/texture_atlas.py
[ ] Create TextureAtlas class
[ ] Move atlas building from canvas_widget
[ ] Move UV mapping system
[ ] Add methods: build_atlas(texture_paths), get_uv(filename)
[ ] Update canvas_widget to use TextureAtlas
[ ] Test: Rendering works with new atlas system
[ ] Commit: "Extract texture atlas system"

Task 5.2: Extract Texture Loaders (2 hours)
--------------------------------------------
[ ] Create components/canvas/texture_loaders.py
[ ] Move _load_texture_atlases() logic
[ ] Move _load_frame_textures() logic
[ ] Move _load_mask_texture() logic
[ ] Move _load_material_mask_texture() logic
[ ] Move _load_noise_texture() logic
[ ] Create load_all_textures() function
[ ] Update canvas_widget to use loaders
[ ] Test: All textures load correctly
[ ] Commit: "Extract texture loaders"

Task 5.3: Extract Render Passes (1.5 hours)
--------------------------------------------
[ ] Create components/canvas/render_passes.py
[ ] Extract render_base_layer(shader, vao, base_texture, colors)
[ ] Extract render_emblems(shader, vao, layers, atlases)
[ ] Extract render_frame(shader, vao, frame_texture, mask)
[ ] Update canvas_widget.paintGL() to call passes
[ ] Test: Rendering looks identical
[ ] Commit: "Extract render passes"

Task 5.4: Extract Handle Strategies (1.5 hours)
------------------------------------------------
[ ] Create components/transform/handles/ directory
[ ] Create base_handle.py with HandleStrategy interface
[ ] Create center_handle.py for translation
[ ] Create corner_handle.py for scaling
[ ] Create edge_handle.py for edge scaling
[ ] Create rotation_handle.py for rotation
[ ] Update transform_widget to use strategy pattern
[ ] Test: All transform handles work
[ ] Commit: "Extract transform handle strategies"

Task 5.5: Test Phase 5 Complete
--------------------------------
[ ] Run application
[ ] Test rendering (base, emblems, frames)
[ ] Test all transform handles
[ ] Test texture loading
[ ] Tag: v5.0-specialized


PHASE 6: INTEGRATION AND CLEANUP (4 hours)
===========================================
Priority: FINAL - Polish and documentation

Task 6.1: Update Main Window (1 hour)
--------------------------------------
[ ] Review main.py - should be ~400 lines
[ ] Verify all logic moved to services/utilities
[ ] Clean up imports
[ ] Add comments for orchestration logic
[ ] Remove any remaining dead code
[ ] Commit: "Clean up main window after refactoring"

Task 6.2: Update Property Sidebar (1 hour)
-------------------------------------------
[ ] Review property_sidebar.py - should be ~400 lines
[ ] Verify all logic moved to widgets/factories
[ ] Update imports to use submodules
[ ] Clean up any duplicate code
[ ] Commit: "Clean up property sidebar after refactoring"

Task 6.3: Update Canvas Widget (1 hour)
----------------------------------------
[ ] Review canvas_widget.py - should be ~300 lines
[ ] Verify texture/render logic extracted
[ ] Update imports
[ ] Document remaining OpenGL setup
[ ] Commit: "Clean up canvas widget after refactoring"

Task 6.4: Update All Imports (30 minutes)
------------------------------------------
[ ] Search for old import paths
[ ] Update to use new module structure
[ ] Fix any circular import issues
[ ] Test all imports work
[ ] Commit: "Update imports to new structure"

Task 6.5: Test Phase 6 Complete
--------------------------------
[ ] Full application test
[ ] Test all features end-to-end
[ ] Check for any regressions
[ ] Run any existing tests
[ ] Tag: v6.0-refactored


PHASE 7: UTILS CLEANUP (2 hours)
=================================
Priority: LOW - Nice to have

Task 7.1: Move Test Code (30 minutes)
--------------------------------------
[ ] Move __main__ section from coa_parser.py to tests/test_coa_parser.py
[ ] Update test to use pytest or unittest
[ ] Run test to verify it works
[ ] Commit: "Move coa_parser test code to tests directory"

Task 7.2: Clean Up Texture Consolidate (30 minutes)
----------------------------------------------------
[ ] Review texture_consolidate.py usage
[ ] If unused, delete entire file
[ ] If used, move to components/canvas/texture_loaders.py
[ ] Update any imports
[ ] Commit: "Clean up texture consolidate module"

Task 7.3: Documentation Update (1 hour)
----------------------------------------
[ ] Update README with new structure
[ ] Document module purposes
[ ] Update architecture diagrams if any
[ ] Add developer guide for new structure
[ ] Commit: "Update documentation for refactored structure"

Task 7.4: Test Phase 7 Complete
--------------------------------
[ ] Review all changes
[ ] Full test of application
[ ] Tag: v7.0-utils-cleanup


TESTING CHECKLIST (Run after each phase)
=========================================
[ ] Application starts without errors
[ ] Load CoA from file
[ ] Save CoA to file
[ ] Copy/paste CoA
[ ] Create new layer from asset
[ ] Duplicate layer (Ctrl+D, button)
[ ] Delete layer
[ ] Transform layer (move, scale, rotate)
[ ] Multi-select layers
[ ] Change colors (base and emblem)
[ ] Change pattern
[ ] Undo/redo operations
[ ] Drag-drop layer reordering


ROLLBACK PLAN
=============
Each phase is committed separately with tags.
If issues arise:
1. Note the failing functionality
2. Check git log for last working commit
3. git revert [commit-hash] or git reset --hard [tag]
4. Fix issue before continuing
5. Recommit with fix


PROGRESS TRACKING
=================
Phase 1: [ ] Complete - Est: 2 hours  
Phase 2: [ ] Complete - Est: 4 hours
Phase 3: [ ] Complete - Est: 6 hours
Phase 4: [ ] Complete - Est: 8 hours
Phase 5: [ ] Complete - Est: 8 hours
Phase 6: [ ] Complete - Est: 4 hours
Phase 7: [ ] Complete - Est: 2 hours
Phase 8: [ ] Complete - Est: 2.5 hours

Total: 36.5 hours estimated
Actual: _____ hours

Start Date: __________
End Date: __________


NOTES AND ISSUES
================
(Document any problems, deviations, or decisions made during refactoring)
